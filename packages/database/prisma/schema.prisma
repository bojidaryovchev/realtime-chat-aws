// Prisma schema for Realtime Chat Application
// Supports: users, conversations, messages, receipts, presence

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          String     @id @default(uuid())
  email       String     @unique
  username    String     @unique
  displayName String
  avatarUrl   String?
  status      UserStatus @default(OFFLINE)
  pushToken   String?
  auth0Id     String?    @unique // Auth0 user ID (sub claim)
  lastSeenAt  DateTime   @default(now())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  messages                 Message[]
  conversationParticipants ConversationParticipant[]
  messageReceipts          MessageReceipt[]

  @@map("users")
}

enum UserStatus {
  ONLINE
  OFFLINE
  AWAY

  @@map("user_status")
}

model Conversation {
  id        String           @id @default(uuid())
  type      ConversationType
  name      String?
  avatarUrl String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

enum ConversationType {
  DIRECT
  GROUP

  @@map("conversation_type")
}

model ConversationParticipant {
  id             String          @id @default(uuid())
  conversationId String
  userId         String
  role           ParticipantRole @default(MEMBER)
  joinedAt       DateTime        @default(now())
  lastReadAt     DateTime?

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

enum ParticipantRole {
  ADMIN
  MEMBER

  @@map("participant_role")
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  type           MessageType @default(TEXT)
  metadata       Json        @default("{}")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  deletedAt      DateTime?

  // Relations
  conversation Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User             @relation(fields: [senderId], references: [id], onDelete: Cascade)
  receipts     MessageReceipt[]

  @@index([conversationId, createdAt])
  @@map("messages")
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM

  @@map("message_type")
}

model MessageReceipt {
  id          String    @id @default(uuid())
  messageId   String
  userId      String
  deliveredAt DateTime?
  readAt      DateTime?

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@map("message_receipts")
}
